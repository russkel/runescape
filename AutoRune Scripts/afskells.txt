;---------------
; Easy Auto-Fight
; Auto-Generated by AutoRune
; Created by Kaitnieks
; For fighting NPCs type 40
; With fight mode 1
; Don't attack if HP below 20

@Boo:
SetOnPlaceTime(600)
OnLogin(@Init)
@Init:
EnableEvents()
; Set up some events
OnCoordsChanged(@CoordsChange,%oldX,%oldY)
OnStatsChanged(@StatsChange,%Stat)
OnServerMessage(@ServMes)
-OnItemAppeared(@NewItem,%ItemID,%X,%Y)

; Set it to train strength or whatever
FightMode(1)
; Ignore those NPCs that are in fight
CheckFighters(1)
; Let AR know, that we are not in fight
SetVarNum(%FightOver,1)


@MainLoop:
GoToIfCoordsIn(@StuckWithRats,205,3282,210,3288)
GoToIfCoordsIn(@Room1,204,3291,211,3292)
GoToIfCoordsIn(@Room2,212,3289,219,3294)
GoToIfCoordsIn(@DoorRoom,219,3279,223,3283)

------------####
GoToIfCountInInventoryEqual(@BackToBank,0,359)
------------####
; Don't attack if we are already fighting
GoToIfVarEqualNum(@DontAttack,%FightOver,0)
; Attack if any enemies visible
GoToIfNPCNear(@Attack,40)
; Otherwise don;t attack
GoTo(@DontAttack)


@Attack:
; Attack only if my HP is above certain number
; or unknown
SetVarMyHP(%HP)
GoToIfVarEqualNum(@Attack2,%HP,0)
GoToIfVarBelowNum(@EatFood,%HP,20)


@Attack2:
; get coords and ID of nearest enemy
SetVarsNearestNPC(%x,%y,%ID,40)
; attack the enemy
ActionVarVar(%x,%y)
AttackNPCVar(%ID)
; let AR know that we are in fight now
SetVarNum(%FightOver,0)
; reset idle counter
SetVarNum(%IdleC,0)
GoTo(@DontAttack)

@EatFood:
UseItemByID(359)
Wait(10)
UseItemByID(359)
Wait(10)
UseItemByID(359)
Wait(10)

@DontAttack:
Wait(5,6)

; count how many loops we are idling
AddVarNum(%IdleC,1)
; if more than 20 loops - attack next enemy
GoToIfVarAboveNum(@FightNext,%IdleC,20)
; if more than 4 loops - burry all bones we have
GoToIfVarAboveNum(@IHaveBones,%IdleC,4)
GoTo(@MainLoop)


@FightNext:
; tell AR that we are not fighting
SetVarNum(%FightOver,1)
; reset idle counter
SetVarNum(%IdleC,0)

GoTo(@MainLoop)


@IHaveBones:
; don't dig bones if we are fighting
GoToIfVarEqualNum(@NotWorthToDig,%FightOver,0)
; dig only if I do have bones
GoToIfInInventory(@IReallyHaveBones,20)
GoTo(@NotWorthToDig)
@IReallyHaveBones:
GoSub(@DigBones)
@NotWorthToDig:
GoTo(@MainLoop)


;--- OnStatChaged
@StatsChange:
@CanMove:
;If my HitPoints skill changed, it means
;fight is over
GoToIfVarEqualNum(@SetCanMove,%Stat,3)
ERet()
@SetCanMove:
SetVarNum(%FightOver,1)
SetVarNum(%IdleC,0)
ERet()


;--- OnServerMessage
@ServMes:
;-- If someone stole your enemy
GoToIfLastServerMessageIs(@ResetGo,"I can't get close enough")
;-- or your victim runs away
GoToIfLastServerMessageIs(@ResetGo,"Your opponent is retreating")
---------
GoToIfLastServerMessageIs(@Sleep,"@gre@You are too tired to gain experience, get some rest!")
---------
GoToIfInLastServerMessageIs(@LVL,"advance")
ERet()

@LVL:
Debug("LVL!")
ERet()

@Sleep:
Debug("Sleeping")
UseItem(5)
SetVarNum(%SleepTime,0)
SetVarNum(%MaxSleepTime,35)
@Sleeping:
Wait(10)
AddVarNum(%SleepTime,1)
GoToIfVarAbove(@Sleep,%SleepTime,%MaxSleepTime)
GoToIfLastServerMessageIsNot(@Sleeping,"You wake up - feeling refreshed")
@Slept:
ERet()

ERet()
;-- then let AR know that fight is over
@ResetGo:
SetVarNum(%FightOver,1)
ERet()

@goback:
OnCoordsChanged(@CoordsChange,%oldX,%oldY)
Ret()

- Anti Jagex
@CoordsChange:

GoTo(@CheckTeleport)
@CheckY:
GoTo(@CheckGoUp)
GoTo(@CheckTeleport)
@CheckGoUp:
ERet()



@CheckTeleport:
SetVarMyX(%x)
SetVarMyY(%y)
SetVar(%diff,%oldX)
AddVarNum(%diff,40)
GoToIfVarAbove(@RunAndHideTele,%x,%diff)
SetVar(%diff,%oldX)
AddVarNum(%diff,-40)
GoToIfVarBelow(@RunAndHideTele,%x,%diff)

SetVar(%diff,%oldY)
AddVarNum(%diff,40)
GoToIfVarAbove(@RunAndHideTele,%y,%diff)
SetVar(%diff,%oldY)
AddVarNum(%diff,-40)
GoToIfVarBelow(@RunAndHideTele,%y,%diff)

ERet()

@RunAndHideTele:
Wait(25,30)
Say(16 13 05 )
Debug("Saying 'Wtf'")
Wait(10)
SaveScreenshot()
Debug("Ooops we just got teleported! Must be an admin!!!")
DebugVar(%x,%y,%oldX,%oldY)
GoTo(@RunAndHide)

@RunAndHidePick:
Debug("Ooops we just lost pickaxe! Must be an admin!!!")
GoTo(@RunAndHide)

@RunAndHideChat:
Debug("Ooops someone is talking in the game. If chat messages are blocked - its an admin!!!")
GoTo(@RunAndHide)

@RunAndHidePM:
Debug("Ooops someone is PMing you in the game. If PMs are blocked - its an admin!!!")
GoTo(@RunAndHide)

@RunAndHide:
SaveScreenshot()
RedirectDest(0,50,0,0,0,0,0,0)
StopAndLogOut()
Wait(1)

;--- New item appeared
@NewItem:
;-- If we're not fighting or burying bones
; then take the item
GoToIfVarEqualNum(@TakeItems,%FightOver,1)
ERet()
@TakeItems:
SetVarMyX(%MX)
SetVarMyY(%MY)
;Only take the item if it's right under my feet
GoToIfVarNotEqual(@DontGrabAnything,%X,%MX)
GoToIfVarNotEqual(@DontGrabAnything,%Y,%MY)
;-- Only take certain items
GoToIfVarNotEqualNum(@DontGrabBones,%ItemID,20)
-GoTo(@GrabBones)
@DontGrabBones:

GoToIfVarNotEqualNum(@DontGrabArrows,%ItemID,11)
GoTo(@GrabArrows)
@DontGrabArrows:


GoToIfVarNotEqualNum(@DontGrabCoins,%ItemID,10)
GoTo(@GrabCoins)
@DontGrabCoins:

GoToIfVarNotEqualNum(@DontGrabNat,%ItemID,40)
GoTo(@GrabNat)
@DontGrabNat:

GoToIfVarNotEqualNum(@DontGrabChao,%ItemID,41)
GoTo(@GrabChao)
@DontGrabChao:


@DontGrabAnything:
ERet()

;---Pick up bones
@GrabBones:
ActionVarVar(%X,%Y)
TakeItemVarVar(%X,%Y,20)
Wait(10)
GoTo(@DontGrabBones)

;---Pick up Arrows
@GrabArrows:
ActionVarVar(%X,%Y)
TakeItemVarVar(%X,%Y,11)
Wait(10)
GoTo(@DontGrabArrows)

;---Pick up coins
@GrabCoins:
ActionVarVar(%X,%Y)
TakeItemVarVar(%X,%Y,10)
Wait(10)
GoTo(@DontGrabCoins)

;---Pick up coins
@GrabNat:
ActionVarVar(%X,%Y)
TakeItemVarVar(%X,%Y,40)
Wait(10)
GoTo(@DontGrabNat)

@GrabChao:
ActionVarVar(%X,%Y)
TakeItemVarVar(%X,%Y,41)
Wait(10)
GoTo(@DontGrabChao)

;--- Dig all bones
@DigBones:
; Don't dig if we are in fight
GoToIfVarEqualNum(@DontDig,%FightOver,0)
@DigBonesLoop:
UseItemByID(20)
Wait(20)
; if we still have bones, keep digging
GoToIfInInventory(@DigBonesLoop,20)
@DontDig:
Ret()
-


@BackToBank:
OnStatsChanged(-1,%Stat)
OnServerMessage(-1)
OnItemAppeared(-1,%ItemID,%X,%Y)

MoveTo(216,3284,1,1)
MoveTo(217,3291,1,1)
MoveTo(216,3294,0,1,-1,2)
MoveTo(215,3299)
OnCoordsChanged(-1,%a,%a)
Action(215,3299)
AtObject(215,3300)
WaitForCoordChange()

MoveTo(218,467)
MoveTo(218,460)
MoveTo(215,460,0,-2,-2,-4)
MoveTo(212,456,-1,-1)
MoveTo(211,448)
MoveTo(211,447,6,0)
MoveTo(217,449)

@Banking:

GoToIfCoordsIn(@AmInsideBank,212,220,448,453)
GoTo(@GoInsideBank)

@GoInsideBank:
MoveTo(218,448)
MoveTo(218,448)
GoTo(@Banking)

@AmInsideBank:
GoToIfNPCNear(@ISeeBanker,95)

Debug("I don't see any bankers here!")
GoTo(@Banking)

; Talk to the nearest banker every time
@ISeeBanker:
ResetQuestMenu()
SetVarsNearestNPCIn(%x,%y,%ID,212,220,448,453,95)
ActionVarVar(%x,%y)
TalkToNPCVar(%ID)
WaitForQuestMenu(30)
GoToIfQuestMenu(@ContactWithBanker)
GoTo(@Banking)

@ContactWithBanker:
Answer(0)
WaitForBankWindow(50)
SetVarNum(%a,23)
@wd:
Withdraw(359,1)
Wait(1)
AddVarNum(%a,-1)
GoToIfVarEqualNum(@Done,%a,0)
GoTo(@wd)
@Done:
Wait(10)
CloseBank()

GoToIfCountInInventoryEqual(@BackToHellHole,24,359)
GoTo(@Banking)

@BackToHellHole:
MoveTo(218,448)
MoveTo(218,447)
MoveTo(211,447)
MoveTo(211,455)
MoveTo(215,455,2,2)
MoveTo(217,463,1,1)
MoveTo(218,468)
MoveTo(216,468)
Action(216,468)
AtObject(215,468)
WaitForCoordChange()
GoSub(@goback)

MoveTo(216,3284,1,-1)
MoveTo(216,3273)
GoTo(@Boo)

@StuckWithRats:
MoveTo(206,3286)
MoveTo(207,3292)
;out of rats
@Room1:
MoveTo(211,3292)
MoveTo(216,3292)
@Room2:
Wait(10)
MoveTo(217,3288)
GoTo(@Boo)

@DoorRoom:
MoveTo(219,3282)
Action(219,3282)
OpenDoor(219,3282,1)
Wait(40)
GoTo(@Boo)
